name: "[CI] - Lint Commits - Manual"
run-name: "@PR â€¢ Lint Commits triggered by ${{ github.event_name == 'pull_request' && github.event.sender.login || inputs.login || 'unknown' }} ${{ format('on branch {0}', github.event_name == 'pull_request' && github.event.pull_request.head.ref || inputs.ref || 'unknown') }}"

on:
  workflow_dispatch:
    inputs:
      ref:
        description: The commit/branch to lint
        required: true
      from:
        description: Lower end of the commit range to lint
        required: true
      login:
        description: The GitHub username that triggered the workflow
        required: false
  pull_request: ~

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  id-token: write
  contents: read

jobs:
  lint-commits:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.ref || inputs.ref }}
          fetch-depth: 0
      - name: Setup the caches
        uses: LedgerHQ/ledger-live/tools/actions/composites/setup-caches@develop
        id: setup-caches
        with:
          install-proto: true
          skip-turbo-cache: "false"
          accountId: ${{ secrets.AWS_ACCOUNT_ID_PROD }}
          roleName: ${{ secrets.AWS_CACHE_ROLE_NAME }}
          region: ${{ secrets.AWS_CACHE_REGION }}
          turbo-server-token: ${{ secrets.TURBOREPO_SERVER_TOKEN }}
      - name: Install dependencies
        run: pnpm i --filter="ledger-live"
      - name: Lint commits
        run: |
          set -o pipefail
          pnpm commitlint --from ${{ github.event_name == 'pull_request' && format('origin/{0}', github.event.pull_request.base.ref) || (inputs.from && format('origin/{0}', inputs.from) || 'HEAD^1') }} --verbose