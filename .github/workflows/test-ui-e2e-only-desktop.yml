name: "[Desktop] - E2E Test - Scheduled"
run-name: "@Desktop ‚Ä¢ UI e2e ‚Ä¢ Test App triggered by ${{ github.actor }} ${{ format('on ref {0}', github.ref_name) }}"

on:
  schedule:
    - cron: "0 4 * * 1-5"
  workflow_dispatch:
    inputs:
      test_filter:
        description: Filter pattern(s) to execute only selected test suites by test name, file path or tag, separated by ',' or '|' (e.g. "Accounts @smoke", "@bitcoin,@family-evm" or "Accounts @smoke|Settings")
        required: false
      invert_filter:
        description: Ignore test having name pattern (entered in the previous field)
        type: boolean
        default: false
      slack_notif:
        description: "Send notification to Slack?"
        required: false
        type: boolean
        default: false
      export_to_xray:
        description: Send tests results to Xray
        required: false
        type: boolean
        default: false
      test_execution:
        description: "Test Execution ticket ID"
        required: false
        type: string
      enable_broadcast:
        description: "Enable transaction broadcast"
        required: false
        type: boolean
        default: false
      build_type:
        description: "Firebase env to target (pick js for release testing)"
        required: false
        type: choice
        options:
          - js
          - staging
          - testing
        default: testing
      speculos_device:
        description: "Device to be used"
        required: false
        type: choice
        options:
          - nanoS
          - nanoSP
          - nanoX
          - stax
          - flex
          - nanoGen5
        default: nanoSP
      smoke_tests:
        description: "Run smoke tests"
        required: false
        type: boolean
        default: false

  workflow_call:
    inputs:
      ref:
        description: "The branch which triggered this workflow"
        required: false
        type: string
      test_filter:
        description: Filter pattern(s) to execute only selected test suites by test name, file path or tag, separated by ',' or '|' (e.g. "Accounts @smoke", "@bitcoin,@evm" or "Accounts @smoke|Settings")
        required: false
        type: string
      invert_filter:
        description: Ignore test having name pattern (entered in the previous field)
        type: boolean
        default: false
      slack_notif:
        description: "Send notification to Slack?"
        required: false
        type: boolean
        default: false
      enable_broadcast:
        description: "Enable transaction broadcast"
        required: false
        type: boolean
        default: false
      build_type:
        description: "Firebase env to target (pick js for release testing)"
        required: false
        type: string
        default: testing
      speculos_device:
        description: "Device to be used"
        required: true
        type: string
      smoke_tests:
        description: "Run smoke tests"
        required: false
        type: boolean
        default: false

permissions:
  id-token: write
  contents: read

jobs:
  e2e-tests-linux:
    name: "Ubuntu E2E"
    env:
      NODE_OPTIONS: "--max-old-space-size=7168"
      INSTRUMENT_BUILD: true
      FORCE_COLOR: 3
      CI_OS: "ubuntu-latest"
      PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
      SPECULOS_IMAGE_TAG: ghcr.io/ledgerhq/speculos:${{ inputs.speculos_device == 'nanoS' && '1be65b91a8e0691866f880fd437ac05fce78af9d' || 'latest' }}
      SPECULOS_DEVICE: ${{ inputs.speculos_device || 'nanoSP' }}
    runs-on: [ledger-live-4xlarge-e2e]
    outputs:
      status_1: ${{ steps.set-output.outputs.status_1 }}
      status_2: ${{ steps.set-output.outputs.status_2 }}
      status_3: ${{ steps.set-output.outputs.status_3 }}
      status_4: ${{ steps.set-output.outputs.status_4 }}
    strategy:
      fail-fast: false
      matrix:
        shardIndex: [1, 2, 3, 4]
        shardTotal: [4]
    steps:
      - name: generate token
        id: generate-token
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # 2.2.1
        with:
          app-id: ${{ secrets.GH_BOT_APP_ID }}
          private-key: ${{ secrets.GH_BOT_PRIVATE_KEY }}
          repositories: |
            coin-apps
            ledger-live

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ inputs.ref || github.sha }}
          repository: LedgerHQ/ledger-live
          token: ${{ steps.generate-token.outputs.token }}

      - name: Setup caches
        id: caches
        uses: LedgerHQ/ledger-live/tools/actions/composites/setup-caches@develop
        with:
          skip-turbo-cache: "false"
          accountId: ${{ secrets.AWS_ACCOUNT_ID_PROD }}
          roleName: ${{ secrets.AWS_CACHE_ROLE_NAME }}
          region: ${{ secrets.AWS_CACHE_REGION }}
          turbo-server-token: ${{ secrets.TURBOREPO_SERVER_TOKEN }}

      - uses: LedgerHQ/ledger-live/tools/actions/composites/setup-e2e-test-desktop@develop
        id: setup-test-desktop
        with:
          build_type: ${{ inputs.build_type || 'testing' }}
          turborepo-server-port: ${{ steps.caches.outputs.port }}

      - name: Retrieving coin apps
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: master
          repository: LedgerHQ/coin-apps
          token: ${{ steps.generate-token.outputs.token }}
          path: coin-apps

      - name: Pull docker image
        run: docker pull ${{ env.SPECULOS_IMAGE_TAG }}
        shell: bash

      - name: Set test environment variables
        uses: LedgerHQ/ledger-live/tools/actions/composites/setup-e2e-env@develop
        with:
          enable_broadcast: ${{ inputs.enable_broadcast }}
          build_type: ${{ inputs.build_type }}

      - name: Prepare test filter
        id: test-filter
        run: |
          BASE_FILTER="${{ inputs.test_filter }}"
          if [ -n "$BASE_FILTER" ]; then
            BASE_FILTER="${BASE_FILTER//,/|}"
          fi
          if [ "${{ inputs.smoke_tests }}" = "true" ]; then
            if [ -n "$BASE_FILTER" ]; then
              echo "filter=@smoke $BASE_FILTER" >> $GITHUB_OUTPUT
            else
              echo "filter=@smoke" >> $GITHUB_OUTPUT
            fi
          else
            echo "filter=$BASE_FILTER" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Write summary
        if: ${{ matrix.shardIndex == 1 }}
        run: |
          FILTER_PATTERN="${{ steps.test-filter.outputs.filter }}"
          DEVICE="${{ inputs.speculos_device || 'nanoSP' }}"
          BUILD_TYPE="${{ inputs.build_type || 'testing' }}"
          TEST_EXECUTION="${{ inputs.test_execution || '(not provided)' }}"
          BROADCAST_ENABLED="${{ inputs.enable_broadcast }}"

          if [ -z "$FILTER_PATTERN" ]; then
            FILTER_PATTERN="(none)"
          fi
          {
            echo "## Workflow Context"
            echo ""
            echo "- **Workflow source branch:** ${{ github.workflow_ref }}"
            echo "- **Triggered branch:** ${{ github.ref_name }}"
            echo "- **Commit SHA:** ${{ github.sha }}"
            echo "- **Device selected:** $DEVICE"
            echo "- **Filtered pattern:** $FILTER_PATTERN"
            echo "- **Test Execution ticket ID:** $TEST_EXECUTION"
            echo "- **Firebase env to target:** $BUILD_TYPE"
            echo "- **Broadcast enabled:** $BROADCAST_ENABLED"
          } >> $GITHUB_STEP_SUMMARY

      - name: Run Playwright Tests
        id: run-playwright
        uses: LedgerHQ/ledger-live/tools/actions/composites/run-e2e-playwright-tests@develop
        with:
          speculos_device: ${{ inputs.speculos_device || 'nanoSP' }}
          test_filter: ${{ steps.test-filter.outputs.filter }}
          invert_filter: ${{ inputs.invert_filter || false }}
          shard_index: ${{ matrix.shardIndex }}
          shard_total: ${{ matrix.shardTotal }}
        env:
          SEED: ${{ secrets.SEED_QAA_B2C }}
          XRAY: ${{ inputs.export_to_xray }}
          TEST_EXECUTION: ${{ inputs.test_execution }}
          PROJECT_KEY: B2CQA
          SWAP_API_BASE: ${{ env.SWAP_API_BASE }}
#          REMOTE_SPECULOS: "true"
#          GITHUB_TOKEN: ${{ secrets.LL_SPECULOS_CI }}

      - name: Upload Allure Results
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: allure-results-${{ matrix.shardIndex }}
          path: "e2e/desktop/allure-results"

      - name: Upload Xray Results
        if: ${{ !cancelled() && inputs.export_to_xray }}
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: xray-reports-${{ matrix.shardIndex }}
          path: e2e/desktop/tests/artifacts/xray/xray-report.json

      - name: Set job output based on test result
        id: set-output
        if: ${{ !cancelled() }}
        run: |
          echo "status_${{ matrix.shardIndex }}=${{ steps.run-playwright.outcome }}" >> $GITHUB_OUTPUT
  report-to-allure:
    name: "Create Allure Report and upload it"
    runs-on: [ledger-live-medium]
    needs: e2e-tests-linux
    outputs:
      test_result: ${{ steps.summary.outputs.test_result }}
      status_color: ${{ steps.summary.outputs.status_color }}
      status_emoji: ${{ steps.summary.outputs.status_emoji }}
      report-url: ${{ steps.allure-server.outputs.report-url }}
      missingShards: ${{ steps.aggregate.outputs.missingShards }}
    if: ${{ !cancelled() }}
    env:
      ALLURE_RESULTS: "allure-results"
    steps:
      - name: Download Allure Report
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          path: ${{ env.ALLURE_RESULTS }}
          pattern: ${{ env.ALLURE_RESULTS }}*
          merge-multiple: true
      - name: Publish report on Allure Server
        id: allure-server
        if: ${{ !cancelled() }}
        uses: LedgerHQ/ledger-live/tools/actions/composites/upload-allure-report@develop
        with:
          platform: ${{ github.event_name == 'schedule' && 'linux-speculos-nightly' || (inputs.smoke_tests && 'linux-speculos-smoke' || 'linux-speculos') }}
          login: ${{ vars.ALLURE_USERNAME }}
          password: ${{ secrets.ALLURE_LEDGER_LIVE_PASSWORD }}
          path: ${{ env.ALLURE_RESULTS }}

      - name: Get summary
        if: ${{ !cancelled() && (inputs.slack_notif || github.event_name == 'schedule' )}}
        id: summary
        uses: LedgerHQ/ledger-live/tools/actions/composites/get-allure-summary@develop
        with:
          allure-results-path: ${{ env.ALLURE_RESULTS }}
          platform: linux

      - name: Aggregate test results
        id: aggregate
        uses: LedgerHQ/ledger-live/tools/actions/composites/aggregate-shard-results@develop
        with:
          total_shards: 4
          status_1: ${{ needs.e2e-tests-linux.outputs.status_1 }}
          status_2: ${{ needs.e2e-tests-linux.outputs.status_2 }}
          status_3: ${{ needs.e2e-tests-linux.outputs.status_3 }}
          status_4: ${{ needs.e2e-tests-linux.outputs.status_4 }}

  upload-to-xray:
    name: "Upload to Xray"
    runs-on: [ledger-live-medium]
    env:
      XRAY_CLIENT_ID: ${{ secrets.XRAY_CLIENT_ID }}
      XRAY_CLIENT_SECRET: ${{ secrets.XRAY_CLIENT_SECRET }}
      XRAY_API_URL: https://xray.cloud.getxray.app/api/v2
      JIRA_URL: https://ledgerhq.atlassian.net/browse
    needs: e2e-tests-linux
    if: ${{ !cancelled() && inputs.export_to_xray }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Download Xray Results
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          path: "e2e/desktop/artifacts/xray"
          pattern: xray-reports-*
          merge-multiple: false

      - name: Extract and Aggregate Xray results
        run: e2e/desktop/aggregate-xray-reports.sh e2e/desktop/artifacts/xray

      - name: Upload aggregated xray results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: aggregated-xray-reports
          path: "e2e/desktop/artifacts/xray/aggregated-xray-reports.json"

      - name: Authenticate to Xray
        id: authenticate
        run: |
          response=$(curl -H "Content-Type: application/json" -X POST --data '{"client_id": "${{ secrets.XRAY_CLIENT_ID }}", "client_secret": "${{ secrets.XRAY_CLIENT_SECRET }}"}' ${{ env.XRAY_API_URL }}/authenticate)
          echo "xray_token=$response" >> $GITHUB_OUTPUT
      - name: Publish merged report on Xray
        id: publish-xray
        run: |
          response=$(curl -H "Content-Type: application/json" \
                    -H "Authorization: Bearer ${{ steps.authenticate.outputs.xray_token }}" \
                    -X POST \
                    --data @e2e/desktop/artifacts/xray/aggregated-xray-reports.json \
                    ${{ env.XRAY_API_URL }}/import/execution)
            key=$(echo $response | jq -r '.key')
            echo "xray_key=$key" >> $GITHUB_OUTPUT
      - name: Write Xray report in summary
        shell: bash
        run: echo "::notice title=Xray report URL::${{ env.JIRA_URL }}/${{ steps.publish-xray.outputs.xray_key }}"

  notify-to-slack:
    name: "Notify to slack"
    runs-on: [ledger-live-medium]
    needs: report-to-allure
    if: ${{ !cancelled() && (inputs.slack_notif || github.event_name == 'schedule' )}}
    env:
      MISSING_SHARDS: ${{ needs.report-to-allure.outputs.missingShards }}
    steps:
      - uses: actions/github-script@v7
        name: prepare status
        id: status
        env:
          STATUS_EMOJI: ${{ needs.report-to-allure.outputs.status_emoji }}
          EXPORT_TO_XRAY: ${{ inputs.export_to_xray }}
          TEST_EXECUTION: ${{ github.event.inputs.test_execution }}
        with:
          script: |
            const fs = require("fs");
            const statusEmoji = process.env.STATUS_EMOJI;
            const blocks = [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": ":ledger-logo: Ledger Live Desktop E2E tests results on ${{ github.ref_name }} - ${{ inputs.speculos_device || 'nanoSP' }}${{ inputs.smoke_tests && ' (Smoke Tests)' || '' }}",
                  "emoji": true
                }
              },
              {
                "type": "divider"
              },
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": `- üêß linux : ${statusEmoji} ${{ needs.report-to-allure.outputs.test_result || 'No test results' }}`
                }
              }
            ];
            if (process.env.MISSING_SHARDS) {
              blocks.push({
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": `‚ö†Ô∏è Warning: Missing results for shard(s): ${process.env.MISSING_SHARDS}.`
                }
              });
            }
            blocks.push({
              "type": "divider"
            });
            blocks.push({
              "type": "section",
              "fields": [
                {
                  "type": "mrkdwn",
                  "text": "*Allure Report*\n<${{ needs.report-to-allure.outputs.report-url }}|allure-results-linux>"
                },
                {
                  "type": "mrkdwn",
                  "text": "*Workflow*\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Workflow Run>"
                }
              ]
            });
            if (process.env.EXPORT_TO_XRAY === 'true') {
              blocks.push({
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": `*Xray Link*\n<https://ledgerhq.atlassian.net/browse/${process.env.TEST_EXECUTION}|Test Execution>`
                  }
                ]
              });
            }
            const slackPayload = {
              "attachments": [
                {
                  "color": "${{ needs.report-to-allure.outputs.status_color }}",
                  blocks
                }
              ]
            };
            fs.writeFileSync("payload-slack-content.json", JSON.stringify(slackPayload), "utf-8");
      - name: Print Slack Payload Content
        run: cat ${{ github.workspace }}/payload-slack-content.json

      - name: Post to a Slack channel
        id: slack
        uses: slackapi/slack-github-action@v1.23.0
        with:
          channel-id: "C05FKJ7DFAP"
          payload-file-path: ${{ github.workspace }}/payload-slack-content.json
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_LIVE_CI_BOT_TOKEN }}
          STATUS_COLOR: ${{ needs.report-to-allure.outputs.status_color }}
