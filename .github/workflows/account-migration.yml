name: "Account migration test"
   
on:
    workflow_dispatch:
      inputs:
          currency:
            description: "Currency to run the migration test on. If not specified the test will be run on all supported currencies"
            required: false

    push:
      branches:
        - "feat/live-11055-migration-account-test"

jobs:
    account_migration:
        name: "account-migration"
        runs-on: ubuntu-latest
        steps:
          - name: generate token
            id: generate-token
            uses: tibdex/github-app-token@v1
            with:
              app_id: ${{ secrets.GH_BOT_APP_ID }}
              private_key: ${{ secrets.GH_BOT_PRIVATE_KEY }}
          - uses: actions/checkout@v4
            with:
              ref: develop
              token: ${{ steps.generate-token.outputs.token }}

          - name: Setup git user
            uses: ./tools/actions/composites/setup-git-user
      
          - name: Setup the toolchain
            uses: ./tools/actions/composites/setup-toolchain

          - name: install dependencies and build
            run: |
              pnpm i
              pnpm build:llc

          - name: Run synchronisation on develop
            run: |
                OUTPUT=$(pnpm common test-account-migration  ${{ inputs.currency }})
                echo $OUTPUT > develop-sync.json
                cat develop-sync.jsion

          - uses: actions/checkout@v4
            with:
              token: ${{ steps.generate-token.outputs.token }}

          - name: install dependencies and build
            run: |
              pnpm i
              pnpm build:llc

          - name: run synchronisation on current commit
            run: |
              OUTPUT=$(pnpm common test-account-migration  ${{ inputs.currency }})
              echo $OUTPUT > commit-sync.json
              cat commit-sync.json

          - name: Check that the files are the exact same
            uses: LouisBrunner/diff-action@v2.0.0
            with:
              old: develop-sync.json
              new: commit-sync.json
              mode: strict
              tolerance: same
              output: sync-diff.json
