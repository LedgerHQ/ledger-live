name: "Dynamic cal importer ERC20 - [Staging]"
on:
  workflow_dispatch:

concurrency:
  group: bot-dyn-cal

permissions:
  id-token: write
  contents: read

jobs:
  run-bot:
    runs-on: ledgerhq-shared-small
    steps:
      - uses: actions/checkout@v4
      - name: Retrieving crypto-assets
        uses: actions/checkout@v4
        with:
          submodules: true
          repository: LedgerHQ/crypto-assets
          token: ${{ secrets.CI_BOT_TOKEN }}
          path: crypto-assets
      - name: Setup the toolchain
        uses: ./tools/actions/composites/setup-toolchain
        id: toolchain
        with:
          skip_turbo_cache: "false"
          accountId: ${{ secrets.AWS_ACCOUNT_ID_PROD }}
          roleName: ${{ secrets.AWS_CACHE_ROLE_NAME }}
          region: ${{ secrets.AWS_CACHE_REGION }}
          turbo-server-token: ${{ secrets.TURBOREPO_SERVER_TOKEN }}
      - name: install and build
        continue-on-error: true
        run: |
          pnpm i --filter="live-cli..." --filter="ledger-live" --filter="ledger-libs"
          pnpm build:ljs --api="http://127.0.0.1:${{ steps.toolchain.outputs.port }}" --token="${{ secrets.TURBOREPO_SERVER_TOKEN }}" --team="foo"
        shell: bash
      - name: run script
        run: |
          shopt -s globstar
          out=$PWD/cal
          mkdir $out
          node libs/ledgerjs/script/crypto-assets-importer/index.js $PWD/crypto-assets true
          cd libs/ledgerjs/packages/cryptoassets/src/data
          cp -vf --parents **/*.json $out
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID_STG }}:role/ledger-live-assets-github-role
          aws-region: ${{ vars.AWS_REGION }}
      - name: Deploy json to s3 STG
        run: aws s3 sync ./cal/ s3://ledger-live-cryptoassets-stg/cryptoassets --delete --acl public-read
      - name: Cache invalidate STG
        run: aws cloudfront create-invalidation --distribution-id E2NGFIXS9QJTH --paths "/cryptoassets/*" --debug
