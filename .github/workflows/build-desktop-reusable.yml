name: "[Mobile] - Mock Test - Called"

on:
  workflow_call:
    inputs:
      macos-specificity-runner-label:
        description: The specificity runner label to run the tests on (e.g. performance-pool, performance-pool or runner)
        required: false
        type: string
        default: "general-pool"
      disable-turbo-cache:
        description: Disable turbo caching
        required: false
        type: boolean
        default: false
      ref:
        description: Ref to checkout
        required: false
        type: string

  workflow_dispatch:
    inputs:
      ref:
        description: |
          If you run this manually, and want to run on a PR, the correct ref should be refs/pull/{PR_NUMBER}/merge to
          have the "normal" scenario involving checking out a merge commit between your branch and the base branch.
          If you want to run only on a branch or specific commit, you can use either the sha or the branch name instead (prefer the first verion for PRs).
        type: string
        required: false
      login:
        description: The GitHub username that triggered the workflow
        type: string
        required: false
      macos-specificity-runner-label:
        description: The specificity runner label to run the tests on (e.g. performance-pool, performance-pool or runner)
        required: false
        type: string
        default: "general-pool"
      production_firebase:
        description: "Target Firebase Production env"
        required: false
        type: boolean
        default: false

permissions:
  id-token: write
  contents: read

env:
  SHOULD_UPLOAD: ${{ (github.event_name == 'push' && contains(fromJson('["develop", "main"]'), github.ref_name)) }}
  cache-bucket: ll-gha-s3-cache
  ANDROID_APK_PATH: apps/ledger-live-mobile/android/app/build/outputs/apk/detox/app-x86_64-detox.apk
  ANDROID_JSBUNDLE_PATH: apps/ledger-live-mobile/main.jsbundle
  ANDROID_TESTBINARY_PATH: apps/ledger-live-mobile/android/app/build/outputs/apk/androidTest/detox/app-detox-androidTest.apk
  IOS_JSBUNDLE_PATH: apps/ledger-live-mobile/ios/build/Build/Products/Release-iphonesimulator/ledgerlivemobile.app/main.jsbundle
  IOS_NATIVE_PATH: apps/ledger-live-mobile/ios/build/Build/Products/Release-iphonesimulator

jobs:

  build-ios:
    name: "iOS Build"
    uses: LedgerHQ/ledger-live/.github/workflows/test-mobile-build-ios-reusable.yml@support/poc-macOS-sharding
    with:
      ref: ${{ inputs.ref || github.sha }}
      macos-specificity-runner-label: ${{ inputs.macos-specificity-runner-label }}
      disable-turbo-cache: ${{ inputs.disable-turbo-cache || false }}
      build-ios-js: false
      build-ios-native: true
      ios-native-cache-key: networking-test-1
      ios-js-cache-key: networking-test-2
    secrets: inherit
