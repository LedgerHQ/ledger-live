name: "Check Pull Request"
on:
  pull_request:
    branches:
      - develop
      - release
      - master
      - "feat/**"
    types: [opened, reopened]

jobs:
  check-branch-naming:
    runs-on: ubuntu-latest
    outputs:
      valid: ${{ steps.valid.outputs.valid }}
    steps:
      - name: checkout
        run: |
          gh pr checkout ${{ github.event.number}}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/github-script@v5
        id: valid
        with:
          script: |
            const branch = context.payload.pull_request.head.ref
            const isValid = /^(feat|support|bugfix)\/.+/.test(branch) || ["release", "hotfix"].includes(branch)
            console.log(`::set-output name=valid::${isValid}`)
            if (!isValid) {
              const body = `
            Unfortunately this branch does not follow the [CONTRIBUTING.MD](https://github.com/LedgerHQ/ledger-live/blob/monorepo-setup/CONTRIBUTING.md) conventions and will be closed automatically.
            Feel free to reopen this PR once you have browsed through the guidelines.
              `

              github.rest.issues.createComment({
                owner: "LedgerHQ",
                repo: "ledger-live",
                issue_number: "${{ github.event.pull_request.number }}",
                body,
              });
            }

  close-pr:
    needs: [check-branch-naming]
    if: ${{ needs.check-branch-naming.outputs.valid == 'false' }}
    runs-on: ubuntu-latest
    steps:
      - name: close PR
        run: |
          gh pr close ${{ github.event.number}}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  comment-on-pr:
    needs: [check-branch-naming]
    if: ${{ needs.check-branch-naming.outputs.valid == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          repository: ${{github.event.pull_request.head.repo.full_name}}
          persist-credentials: false
      - name: comment on PR (support and bugfix branches)
        if: contains(github.head_ref, 'support/') || contains(github.head_ref, 'bugfix/')
        uses: actions/github-script@v5
        with:
          script: |
            await github.rest.issues.createComment({
              owner: "LedgerHQ",
              repo: "ledger-live",
              issue_number: "${{ github.event.pull_request.number }}",
              body: `
              Thanks for your contribution.
              To be able to merge in _develop_ branch, you need to:

              - [ ] pass the CI
              - [ ] if needed, run \`/generate-screenshots\`
              - [ ] have a dev review
              - [ ] have a QA review
              - [ ] if needed, \`/upgrade-llc\`


              ### Why /generate-screenshots ?

              If your PR contains UI related changes,
              it might be necessary to regenerate screenshots.

              ### Why /upgrade-llc ?

              If your PR requires an update to the ledger-live-common library,
              once the PR is merged on develop on ledger-live-common side,
              you need to run \`/upgrade-llc\` to switch back to ledger-live-common@develop here before merging.
              `
            });
      - name: comment on PR (feature branches)
        if: contains(github.head_ref, 'feat/')
        uses: actions/github-script@v5
        with:
          script: |
            await github.rest.issues.createComment({
              owner: "LedgerHQ",
              repo: "ledger-live",
              issue_number: "${{ github.event.pull_request.number }}",
              body: `
              Thanks for your contribution.
              To be groomed for next release, you need to:

              - [ ] pass the CI
              - [ ] if needed, run \`/generate-screenshots\`
              - [ ] have a dev review
              - [ ] have a QA review


              ### Why /generate-screenshots ?

              If your PR contains UI related changes,
              it might be necessary to regenerate screenshots.
              `
            });
