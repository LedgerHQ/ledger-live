name: "Cache Exists"
description: "Check if a cache key exists in S3/R2 storage"
inputs:
  endpoint:
    description: the S3 endpoint URL, e.g., 's3.amazonaws.com'
    type: string
    required: false
  key:
    type: string
    required: true
  accessKey:
    type: string
    required: true
  secretKey:
    type: string
    required: true
  sessionToken:
    type: string
    required: false
  bucket:
    type: string
    required: true
  region:
    type: string
    required: true
outputs:
  cache-hit:
    description: "Indicates if the cache exists"
    value: ${{ steps.check-cache.outputs.cache-hit }}
runs:
  using: "composite"
  steps:
    - name: Install AWS CLI if needed
      shell: bash
      run: |
        if ! command -v aws &> /dev/null; then
          echo "Installing AWS CLI..."
          curl -sS "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
          unzip -q awscliv2.zip
          sudo ./aws/install --update
          rm -rf awscliv2.zip aws
          echo "✅ AWS CLI installed"
        else
          echo "✅ AWS CLI already available: $(aws --version)"
        fi

    - name: Check if cache exists
      id: check-cache
      shell: bash
      run: |
        CACHE_KEY="${{ inputs.key }}"
        BUCKET="${{ inputs.bucket }}"
        ENDPOINT="${{ inputs.endpoint || format('s3.{0}.amazonaws.com', inputs.region) }}"

        echo "Checking for cache key: ${CACHE_KEY}"
        echo "Bucket: ${BUCKET}"
        echo "Endpoint: ${ENDPOINT}"

        # Use head-object to check if the cache file exists
        if aws s3api head-object \
          --bucket "${BUCKET}" \
          --key "${CACHE_KEY}/cache.tzst" \
          --endpoint-url "https://${ENDPOINT}" \
          --region "${{ inputs.region }}" > /dev/null 2>&1; then
          echo "cache-hit=true" >> $GITHUB_OUTPUT
          echo "✅ Cache found: ${CACHE_KEY}/cache.tzst"
        else
          echo "cache-hit=false" >> $GITHUB_OUTPUT
          echo "❌ Cache not found: ${CACHE_KEY}/cache.tzst"
        fi
      env:
        AWS_ACCESS_KEY_ID: ${{ inputs.accessKey }}
        AWS_SECRET_ACCESS_KEY: ${{ inputs.secretKey }}
        AWS_SESSION_TOKEN: ${{ inputs.sessionToken }}
