name: "Upload Allure Report"
description: "Uploading allure report to Allure Server"
inputs:
  login:
    required: true
    description: "Allure Server Login"
  password:
    required: true
    description: "Allure Server Password"
  platform:
    required: true
    description: "Tested Platform"
  path:
    required: true
    description: "Report Path"
  report_path_suffix:
    required: false
    description: "Suffix for allure report path (defaults to platform)"
outputs:
  report-url:
    description: "Allure report URL"
    value: ${{ steps.publish-report.outputs.report-url }}

runs:
  using: composite

  steps:
    - id: branch-name
      uses: tj-actions/branch-names@v6
    - name: Set report path
      id: report-path
      shell: bash
      run: |
        REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
        BRANCH="${{ steps.branch-name.outputs.current_branch }}"
        SUFFIX="${{ inputs.report_path_suffix || inputs.platform }}"
        if [ "${{ github.repository }}" != "LedgerHQ/ledger-live" ]; then
          PATH_VALUE="${REPO_NAME}-${BRANCH}-${SUFFIX}"
        else
          PATH_VALUE="${BRANCH}-${SUFFIX}"
        fi
        echo "path=${PATH_VALUE}" >> "$GITHUB_OUTPUT"
    - name: Compress PNG files
      shell: bash
      run: |
        if command -v pngquant &> /dev/null; then
          echo "pngquant already installed"
        else
          echo "Installing pngquant..."
          if [[ "$OSTYPE" == "darwin"* ]]; then
            brew install pngquant
          else
            sudo apt-get update && sudo apt-get install -y pngquant
          fi
        fi
        
        PNG_COUNT=$(find "${{ inputs.path }}" -type f -name "*.png" 2>/dev/null | wc -l)
        echo "Found $PNG_COUNT PNG files to compress"
        
        if [ "$PNG_COUNT" -gt 0 ]; then
          find "${{ inputs.path }}" -type f -name "*.png" -exec pngquant --quality=65-80 --skip-if-larger --ext .png --force {} \;
          echo "PNG compression completed"
        fi
    - name: Publish report on Allure Server
      id: publish-report
      uses: LedgerHQ/send-to-allure-server-action@2.1.2
      with:
        allure-server-url: "https://ledger-live.allure.green.ledgerlabs.net"
        build-name: ${{ github.workflow }}-${{ inputs.platform }}
        build-url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        username: ${{ inputs.login }}
        password: ${{ inputs.password }}
        path: ${{ steps.report-path.outputs.path }}
        allure-results: ${{ inputs.path }}
    - name: Write Allure report in summary
      shell: bash
      run: echo "::notice title=${{ inputs.platform }} Allure report URL::${{ steps.publish-report.outputs.report-url }}"
