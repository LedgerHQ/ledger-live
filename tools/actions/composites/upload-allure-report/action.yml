name: "Upload Allure Report"
description: "Uploading allure report to Allure Server"
inputs:
  login:
    required: true
    description: "Allure Server Login"
  password:
    required: true
    description: "Allure Server Password"
  platform:
    required: true
    description: "Tested Platform"
  path:
    required: true
    description: "Report Path"
  report_path_suffix:
    required: false
    description: "Suffix for allure report path (defaults to platform)"
outputs:
  report-url:
    description: "Allure report URL"
    value: ${{ steps.publish-report.outputs.report-url }}

runs:
  using: composite

  steps:
    - id: branch-name
      uses: tj-actions/branch-names@v6
    - name: Set report path
      id: report-path
      shell: bash
      run: |
        REPO_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
        BRANCH="${{ steps.branch-name.outputs.current_branch }}"
        SUFFIX="${{ inputs.report_path_suffix || inputs.platform }}"
        if [ "${{ github.repository }}" != "LedgerHQ/ledger-live" ]; then
          PATH_VALUE="${REPO_NAME}-${BRANCH}-${SUFFIX}"
        else
          PATH_VALUE="${BRANCH}-${SUFFIX}"
        fi
        echo "path=${PATH_VALUE}" >> "$GITHUB_OUTPUT"
    - name: Compress PNG files
      shell: bash
      run: ${{ github.action_path }}/compress-pngs.sh "${{ inputs.path }}"
    - name: Publish report on Allure Server
      id: publish-report
      uses: LedgerHQ/send-to-allure-server-action@2.1.2
      with:
        allure-server-url: "https://ledger-live.allure.green.ledgerlabs.net"
        build-name: ${{ github.workflow }}-${{ inputs.platform }}
        build-url: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        username: ${{ inputs.login }}
        password: ${{ inputs.password }}
        path: ${{ steps.report-path.outputs.path }}
        allure-results: ${{ inputs.path }}
    - name: Write Allure report in summary
      shell: bash
      run: echo "::notice title=${{ inputs.platform }} Allure report URL::${{ steps.publish-report.outputs.report-url }}"
