name: "Generate Shards Matrix"
description: "Generates iOS and Android test file lists and sharding matrices for E2E tests with pre-computed shard assignments"
inputs:
  test_directory:
    description: "Directory containing test files (default: e2e/mobile)"
    required: false
    default: "e2e/mobile"
  test_filter:
    description: "Test name filter (space-separated, optional)"
    required: false
    default: ""
  event_name:
    description: "GitHub event name (workflow_dispatch or schedule)"
    required: true
  max_shards:
    description: "Maximum number of shards (optional)"
    required: false
    default: "0"
  ref:
    description: "Branch ref"
    required: true
  ios_timing_cache_key:
    description: "Cache key for iOS timing data"
    required: false
    default: ""
  android_timing_cache_key:
    description: "Cache key for Android timing data"
    required: false
    default: ""
  aws_access_key_id:
    description: "AWS access key ID for cache access"
    required: false
    default: ""
  aws_secret_access_key:
    description: "AWS secret access key for cache access"
    required: false
    default: ""
  aws_session_token:
    description: "AWS session token for cache access"
    required: false
    default: ""
  cache_bucket:
    description: "S3 bucket for cache"
    required: false
    default: ""
  aws_region:
    description: "AWS region for cache"
    required: false
    default: ""
runs:
  using: "composite"
  steps:
    - name: Get test files
      id: test-files
      shell: bash
      run: |
        TEST_FILES=$(node apps/ledger-live-mobile/scripts/shard-tests.mjs "${{ inputs.test_filter }}" "${{ inputs.test_directory }}")
        echo "test_files_for_sharding<<EOF" >> $GITHUB_OUTPUT
        echo "$TEST_FILES"                 >> $GITHUB_OUTPUT
        echo "EOF"                         >> $GITHUB_OUTPUT

    - name: Calculate shard counts
      id: shard-counts
      shell: bash
      run: |
        TEST_COUNT=$(echo "${{ steps.test-files.outputs.test_files_for_sharding }}" | wc -w)

        if [ "${{ inputs.event_name }}" = "schedule" ]; then
          SHARD_COUNT_IOS=12
          SHARD_COUNT_ANDROID=12
        elif [[ "${{ inputs.ref }}" == *"release"* || "${{ inputs.ref }}" == *"hotfix"* ]]; then
          SHARD_COUNT_IOS=6
          SHARD_COUNT_ANDROID=12
        else
          SHARD_COUNT=$(( (TEST_COUNT + 14) / 15 ))
          SHARD_COUNT_IOS=$(( SHARD_COUNT > 3 ? 3 : SHARD_COUNT ))
          SHARD_COUNT_ANDROID=$(( SHARD_COUNT > 12 ? 12 : SHARD_COUNT ))
        fi
        
        if [ "${{ inputs.max_shards }}" -gt 0 ]; then
          if [ "$SHARD_COUNT_IOS" -gt "${{ inputs.max_shards }}" ]; then
            SHARD_COUNT_IOS=${{ inputs.max_shards }}
          fi
          if [ "$SHARD_COUNT_ANDROID" -gt "${{ inputs.max_shards }}" ]; then
            SHARD_COUNT_ANDROID=${{ inputs.max_shards }}
          fi
        fi

        echo "TEST_COUNT=$TEST_COUNT" >> "$GITHUB_ENV"
        echo "SHARD_COUNT_IOS=$SHARD_COUNT_IOS" >> "$GITHUB_ENV"
        echo "SHARD_COUNT_ANDROID=$SHARD_COUNT_ANDROID" >> "$GITHUB_ENV"
        echo "Calculated SHARD_COUNT for event ${{ inputs.event_name }} on ref ${{ inputs.ref }} with $TEST_COUNT tests"
        echo "iOS shards: $SHARD_COUNT_IOS, Android shards: $SHARD_COUNT_ANDROID"

    - name: Setup iOS timing cache
      id: ios-timing-cache
      if: ${{ inputs.ios_timing_cache_key != '' && inputs.cache_bucket != '' }}
      continue-on-error: true
      uses: tespkg/actions-cache/restore@v1
      with:
        path: ${{ inputs.test_directory }}/artifacts/e2e-test-results-ios.json
        key: "${{ inputs.ios_timing_cache_key }}"
        accessKey: ${{ inputs.aws_access_key_id }}
        secretKey: ${{ inputs.aws_secret_access_key }}
        sessionToken: ${{ inputs.aws_session_token }}
        bucket: ${{ inputs.cache_bucket }}
        region: ${{ inputs.aws_region }}
        use-fallback: false

    - name: Setup Android timing cache
      id: android-timing-cache
      if: ${{ inputs.android_timing_cache_key != '' && inputs.cache_bucket != '' }}
      continue-on-error: true
      uses: tespkg/actions-cache/restore@v1
      with:
        path: ${{ inputs.test_directory }}/artifacts/e2e-test-results-android.json
        key: "${{ inputs.android_timing_cache_key }}"
        accessKey: ${{ inputs.aws_access_key_id }}
        secretKey: ${{ inputs.aws_secret_access_key }}
        sessionToken: ${{ inputs.aws_session_token }}
        bucket: ${{ inputs.cache_bucket }}
        region: ${{ inputs.aws_region }}
        use-fallback: false

    - name: Calculate intelligent timeouts
      id: calc-timeouts
      shell: bash
      run: |
        TEST_COUNT=${{ env.TEST_COUNT }}
        SHARD_COUNT_IOS=${{ env.SHARD_COUNT_IOS }}
        SHARD_COUNT_ANDROID=${{ env.SHARD_COUNT_ANDROID }}
        TESTS_PER_SHARD_IOS=$(( (TEST_COUNT + SHARD_COUNT_IOS - 1) / SHARD_COUNT_IOS ))
        TESTS_PER_SHARD_ANDROID=$(( (TEST_COUNT + SHARD_COUNT_ANDROID - 1) / SHARD_COUNT_ANDROID ))

        # iOS timeout calculation: 3 minutes per test + 15 min overhead, min 30, max 120
        IOS_TIMEOUT=$(( TESTS_PER_SHARD_IOS * 3 + 15 ))
        (( IOS_TIMEOUT < 30 )) && IOS_TIMEOUT=30
        (( IOS_TIMEOUT > 120 )) && IOS_TIMEOUT=120
        ANDROID_TIMEOUT=90

        echo "iOS timeout: ${IOS_TIMEOUT} minutes, ${TESTS_PER_SHARD_IOS} tests per shard, total ${SHARD_COUNT_IOS} shards"
        echo "Android timeout: ${ANDROID_TIMEOUT} minutes, ${TESTS_PER_SHARD_ANDROID} tests per shard, total ${SHARD_COUNT_ANDROID} shards"

        echo "ios_timeout=$IOS_TIMEOUT" >> "$GITHUB_OUTPUT"
        echo "android_timeout=$ANDROID_TIMEOUT" >> "$GITHUB_OUTPUT"

    - name: Pre-compute all shard assignments
      id: compute-shards
      shell: bash
      run: |
        TEST_FILES="${{ steps.test-files.outputs.test_files_for_sharding }}"
        SHARD_COUNT_IOS=${{ env.SHARD_COUNT_IOS }}
        SHARD_COUNT_ANDROID=${{ env.SHARD_COUNT_ANDROID }}
        TEST_DIR="${{ inputs.test_directory }}"

        echo "Pre-computing shard assignments for iOS ($SHARD_COUNT_IOS shards) and Android ($SHARD_COUNT_ANDROID shards)"

        # Generate iOS shards with pre-computed file lists
        IOS_MATRIX="["
        for i in $(seq 1 $SHARD_COUNT_IOS); do
          SHARD_FILES=$(node apps/ledger-live-mobile/scripts/shard-tests.mjs "$TEST_FILES" ios "$TEST_DIR" $i $SHARD_COUNT_IOS)
          # Escape for JSON
          SHARD_FILES_ESCAPED=$(echo "$SHARD_FILES" | jq -Rs '.')
          if [ $i -gt 1 ]; then
            IOS_MATRIX="$IOS_MATRIX,"
          fi
          IOS_MATRIX="$IOS_MATRIX{\"shard\":$i,\"total\":$SHARD_COUNT_IOS,\"files\":$SHARD_FILES_ESCAPED}"
        done
        IOS_MATRIX="$IOS_MATRIX]"

        # Generate Android shards with pre-computed file lists
        ANDROID_MATRIX="["
        for i in $(seq 1 $SHARD_COUNT_ANDROID); do
          SHARD_FILES=$(node apps/ledger-live-mobile/scripts/shard-tests.mjs "$TEST_FILES" android "$TEST_DIR" $i $SHARD_COUNT_ANDROID)
          # Escape for JSON
          SHARD_FILES_ESCAPED=$(echo "$SHARD_FILES" | jq -Rs '.')
          if [ $i -gt 1 ]; then
            ANDROID_MATRIX="$ANDROID_MATRIX,"
          fi
          ANDROID_MATRIX="$ANDROID_MATRIX{\"shard\":$i,\"total\":$SHARD_COUNT_ANDROID,\"files\":$SHARD_FILES_ESCAPED}"
        done
        ANDROID_MATRIX="$ANDROID_MATRIX]"

        echo "matrix_ios=$IOS_MATRIX" >> "$GITHUB_OUTPUT"
        echo "matrix_android=$ANDROID_MATRIX" >> "$GITHUB_OUTPUT"

        echo "Generated iOS matrix with $SHARD_COUNT_IOS shards"
        echo "Generated Android matrix with $SHARD_COUNT_ANDROID shards"

        # Log all iOS shards
        echo ""
        echo "=== iOS Shard Assignments ==="
        for i in $(seq 0 $((SHARD_COUNT_IOS - 1))); do
          SHARD_NUM=$((i + 1))
          FILES=$(echo "$IOS_MATRIX" | jq -r ".[$i].files")
          FILE_COUNT=$(echo "$FILES" | wc -w | tr -d ' ')
          echo "Shard $SHARD_NUM/$SHARD_COUNT_IOS ($FILE_COUNT files): $FILES"
        done

        # Log all Android shards
        echo ""
        echo "=== Android Shard Assignments ==="
        for i in $(seq 0 $((SHARD_COUNT_ANDROID - 1))); do
          SHARD_NUM=$((i + 1))
          FILES=$(echo "$ANDROID_MATRIX" | jq -r ".[$i].files")
          FILE_COUNT=$(echo "$FILES" | wc -w | tr -d ' ')
          echo "Shard $SHARD_NUM/$SHARD_COUNT_ANDROID ($FILE_COUNT files): $FILES"
        done
        echo ""

outputs:
  matrix_ios:
    description: "Shards matrix JSON for iOS (includes pre-computed file lists)"
    value: ${{ steps.compute-shards.outputs.matrix_ios }}
  matrix_android:
    description: "Shards matrix JSON for Android (includes pre-computed file lists)"
    value: ${{ steps.compute-shards.outputs.matrix_android }}
  test_files_for_sharding:
    description: "All test files for sharding (space-separated)"
    value: ${{ steps.test-files.outputs.test_files_for_sharding }}
  ios_timeout:
    description: "iOS timeout in minutes"
    value: ${{ steps.calc-timeouts.outputs.ios_timeout }}
  android_timeout:
    description: "Android timeout in minutes"
    value: ${{ steps.calc-timeouts.outputs.android_timeout }}
