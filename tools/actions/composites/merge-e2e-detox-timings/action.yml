name: Merge Timing Files

description: Merge and cache E2E timing files for a given platform

inputs:
  platform:
    description: "Platform (ios or android)"
    required: true
  artifacts_dir:
    description: "Directory containing timing artifacts"
    required: false
    default: "e2e/mobile/artifacts"
  aws_access_key_id:
    description: "AWS access key ID"
    required: true
  aws_secret_access_key:
    description: "AWS secret access key"
    required: true
  aws_session_token:
    description: "AWS session token"
    required: true
  aws_region:
    description: "AWS region"
    required: true
  cache_bucket:
    description: "S3 cache bucket name"
    required: true
  github_ref:
    description: "GitHub ref for cache key"
    required: true
  github_run_id:
    description: "GitHub run ID for cache key"
    required: true
  roleName:
    description: "AWS IAM role name for cache access"
    required: false
  accountId:
    description: "AWS account ID for cache access"
    required: false
  key:
    description: "Cache key prefix for timing files"
    required: true

runs:
  using: "composite"
  steps:
    - name: Checkout repository
      uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      with:
        repository: LedgerHQ/ledger-live
        sparse-checkout: |
          apps/ledger-live-mobile/scripts

    - name: Download timing files
      uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
      with:
        pattern: "${{ inputs.key }}-*"
        merge-multiple: true

    - name: Restore cached timing file
      uses: tespkg/actions-cache/restore@a2e3f005921809689270625bc026d387f73017ae # v1
      with:
        path: ${{ inputs.artifacts_dir }}/e2e-test-results-${{ inputs.platform }}.json
        key: "${{ inputs.key }}"
        accessKey: ${{ inputs.aws_access_key_id }}
        secretKey: ${{ inputs.aws_secret_access_key }}
        sessionToken: ${{ inputs.aws_session_token }}
        bucket: ${{ inputs.cache_bucket }}
        region: ${{ inputs.aws_region }}
        use-fallback: false

    - name: Merge timing files
      shell: bash
      run: |
        apps/ledger-live-mobile/scripts/merge-timing-files.sh \
          --platform "${{ inputs.platform }}" \
          --artifacts-dir "${{ inputs.artifacts_dir }}" \
          --verbose

    - name: Copy merged timing file to artifacts dir
      shell: bash
      run: |
        mkdir -p ${{ inputs.artifacts_dir }}
        cp ./e2e-test-results-${{ inputs.platform }}.json ${{ inputs.artifacts_dir }}/e2e-test-results-${{ inputs.platform }}.json

    - name: Save merged timing file to cache
      uses: tespkg/actions-cache/save@a2e3f005921809689270625bc026d387f73017ae # v1
      with:
        path: ${{ inputs.artifacts_dir }}/e2e-test-results-${{ inputs.platform }}.json
        key: "${{ inputs.key }}"
        accessKey: ${{ inputs.aws_access_key_id }}
        secretKey: ${{ inputs.aws_secret_access_key }}
        sessionToken: ${{ inputs.aws_session_token }}
        bucket: ${{ inputs.cache_bucket }}
        region: ${{ inputs.aws_region }}
        use-fallback: false
